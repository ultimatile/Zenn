---
title: "疑似乱数入門"
emoji: "🦀"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [乱数, 疑似乱数]
published: false
---

## TL;DR
:::message
**シミュレーション用途の乱数生成について勉強したかったら[シミュレーションのための乱数入門](https://www.jspf.or.jp/Journal/PDF_JSPF/9606-08koza.pdf)を読もう！**
:::

## はじめにの前に

https://twitter.com/ultimatile/status/1712798975571775832

~~本記事は数値計算アドベントカレンダー2023 `NaN`日目の記事です．~~
~~昨日は`NaN`さんで`NaN`でした．~~

![](https://storage.googleapis.com/zenn-user-upload/9526dc5b6343-20231202.png)


数値計算アドベントカレンダー2023が生えませんでした．．．
後述しますが，この記事を書くモチベーションも半分無くなってしまったため，かなりざっくりな感じでお送りします．

## はじめに
Monte Carlo法などのシミュレーションでは(擬似)乱数を用いて計算を行います．
その際，`rand`のような乱数を生成する函数を使うことが多いと思いますが，`rand`の実装は言語やライブラリで様々あり，注意しないと落とし穴に嵌ってしまうこともあります．
本記事では，そのような落とし穴を避けるために知っておくと良さそうな乱数の知識をまとめています．
かなり入門的な内容なので擬似乱数オタクの方はそっ閉じしてください．

ざっくり
- 擬似乱数関係の基本的な用語
- 擬似乱数生成器の質とテストについて
- 擬似乱数生成の並列化
- 最近の擬似乱数生成器

あたりの話を書きたかったのですが，

[シミュレーションのための乱数入門](https://www.jspf.or.jp/Journal/PDF_JSPF/9606-08koza.pdf)

というpdfを見つけて，ここに「最近の擬似乱数生成器」以外の話題全部書いてあるやんけとなったので，説明は簡単にして適宜このpdfに飛ばそうかなと思います．

## 乱数とは
乱数とはその名の通り予測不可能なランダムな数のことです．
一般にプログラム処理において「ランダムに〇〇する」という処理を行う際に必要となるものです．
数値計算において，乱数を使ったアルゴリズムはMonte Carlo法と呼ばれます
^[乱択(randomized) algorithmと呼んだ方が乱数を用いたアルゴリズムの名前としてはより正確なようです．]．

### 物理乱数と疑似乱数
乱数には，ハードウェアを利用して生成される物理乱数とアルゴリズムによって生成される疑似乱数の2種類があります.
物理乱数の生成に使われるハードウェアの具体例としては，定電圧ダイオードや放射性物質の崩壊，レーザー光を利用したものなどがあるそうです．
詳しくは[シミュレーションのための乱数入門](https://www.jspf.or.jp/Journal/PDF_JSPF/9606-08koza.pdf)の2.2節「物理乱数」を参照してください．

## TL;DR
- 疑似乱数の実装の性能は主に
  - 周期
  - 均等分布性
  - 生成速度
  - 実行ファイルのサイズ
  - 実行時使用メモリ量
  - 並列実装のしやすさ
  で決まります.
周期の長く及び均等分布性が高いことからMerrsenne Twister法が広くdefaultの疑似乱数生成機として用いられてきました．
<!-- TODO: 続きを書く -->

### コラム: 真正乱数と疑似乱数
乱数には真正乱数と疑似乱数の2種類があります.
真正乱数は物理的なデバイス
<!-- TODO: ここに真正乱数の例を書く仕様は以下を読むhttps://csrc.nist.gov/pubs/sp/800/90/b/final -->
によって生成されます.

一方, 疑似乱数はアルゴリズムによって決定的に生成される数列のことです.
疑似乱数生成器は，同じ条件設定と生成規則(アルゴリズム)を与えると同じ数列を生成するため, 予測不可能な数という意味では乱数ではありません.
擬似乱数が「疑似」乱数と呼ばれるのはこのためです.

物理乱数は基本的に予測不可能で，物理乱数が生成できるのならば, 疑似乱数は必要ないのではないかと思うかもしれません.
しかし, 物理乱数はハードウェアによって生成されるため，生成速度が遅いという問題があります.


物理乱数のおもしろい例として，Cloudflare社のラバランプを紹介します．
以下の画像のようにラバランプという油と水の混合液を用いた間接照明です．
https://x.com/mahtin/status/888251632550424577

ラバランプが何かご存知ない方は実際の様子をこちらの動画で見てみてください.
https://youtu.be/1cUUfMeOijg?si=qdKZ26kgQzVamj-Z
<!-- TODO: 意外と遅くない？pdf2章参照 -->

<!-- TODO: 準乱数の話はここ？ -->

細かい話を始めると沼ですが, ざっくりと物理乱数はハードウェアで生成される予測不可能な乱数, 疑似乱数はソフトウェア(アルゴリズム)で生成される予測可能な乱数ということで良いと思います.

ざっくりと物理乱数と疑似乱数の違いを表形式でまとめると以下のようになります.

| 種類 | 生成方法 | 予測 | 速度 |
| ---- | ---- | ---- | ---- |
| 物理乱数 | ハードウェア | 困難 | 遅い |
| 擬似乱数 | ソフトウェア | 容易 | 速い |

セキュリティ関連など予測不可能性が重要な場面では予測可能な疑似乱数をそのまま使うことはできません．
一方，数値計算では再現性という観点からは予測可能である方が望ましいことが多く, 生成速度も重要になるため, 予測可能で高速な疑似乱数を使うことが多いです.

本記事は数値計算における乱数の記事であるため, 基本的に疑似乱数のみを扱います.
ただし, 擬似乱数の生成に物理乱数を利用することがあるため, ざっくり用語は抑えておいた方が良いため解説を書いています.
また，疑似乱数に似た用語として準乱数(quasirandom number)があります．
擬似乱数と混同する可能性がありますので準乱数についても補足します．

## 基本的な用語
### 周期と均等分布性
擬似乱数生成器は性能指標として**周期(period)**と**均等分布性(equiditribution)**^[均等分布性という訳語は[シミュレーションのための乱数入門](https://www.jspf.or.jp/Journal/PDF_JSPF/9606-08koza.pdf)に合わせました．]を持ちます．

#### 周期
周期とは，乱数生成器が生成する数列が繰り返し出現するまでの長さのことです．
<!-- TODO: 周期の定義 -->

乱数は基本的に一様乱数(uniform random number)という0から1までの区間で等確率に出現する乱数を指すことが多いです．
端の0と1を含むかどうかは用途によって重要になるため注意が必要です．
端の扱いを明確にするために，閉区間や開区間の記法を用いて$[0,1)$乱数と表現することがあります
^[念のために意味を書いておくと，角括弧$([])$が端点を含む閉区間，丸括弧$(())$が端点を含まない開区間を表すので，$[0,1)$乱数は0以上1より小さい乱数を表します]．

- エントロピー(プール)
- seed
<!-- 準乱数の補足 -->
<!-- 準モンテカルロ法の最前線 -->

## 擬似乱数生成器
### 線形合同法
- 混合合同法
- 乗算合同法
### Merseene Twister
### PCG
### Xorshift
https://prng.di.unimi.it
### M系列
maximal length sequence
### counter-based random number generator

各言語の標準ライブラリのデフォルト擬似乱数生成器

Julia Xoshiro256++
https://prng.di.unimi.it/
https://github.com/JuliaLang/julia/issues/27614
https://github.com/JuliaRandom/RNGTest.jl
    TestU01

Numpy PCG
https://www.pcg-random.org/pdf/hmc-cs-2014-0905.pdf

C++ mt19937
https://qiita.com/Nabetani/items/78f14d29e49dbc07945f

## Fortran 
- gfortranの`random_number`は線形合同法(Park&Miller)です^[https://github.com/gcc-mirror/gcc/blob/9693459e030977d6e906ea7eb587ed09ee4fddbd/libgfortran/intrinsics/random_init..f90#L82].
- `fortran-lang/stdlib`の`dist_rand`は`xoshiro256**`(xorshift系列)が実装されているようです^[https://github.com/fortran-lang/stdlib/blob/master/src/stdlib_random.fypp].

## 乱数のクオリティとテスト
疑似乱数のクオリティについて考えてみましょう．
主に「周期性」と「等分布性」の2つの観点からクオリティを評価します．

### 等分布性
一様乱数の等分布性は乱数の出方に偏りがあるかどうかを表します．
さいころを振ったときに各面が出る確率は1/6として扱うことが多いと思いますが，実際は出目の模様の重量が各面で異なるため，何も考えずにサイコロを作ると1が出る確率は1/6ではありません^[[できるだけ等確率になるように作られたさいころもあるようです](https://real-edge.com/shop/hobby/details.html#_kanzen)]^[[どれくらい偏るのか試した記事](https://dailyportalz.jp/kiji/gekiyasu_saikoro-tashikameru)]．
このように，乱数がどれくらい均一に出るかという指標として等分布性があります．

なお，周期性を許容し等分布性のみが必要な場合は準乱数(quasirandom number)と呼ばれます．
疑似乱数は英語でpseudorandom numberで紛らわしいので注意してください．
準乱数は数値積分の評価点生成など周期性が特に問題にならない場面で計算を高速化するために用いられます．

## 文献
擬似乱数ユーザーの方へ-Mersenne Twister法開発者より
https://cir.nii.ac.jp/crid/1520290884433084160
NDLデジタルコレクションのリンクから読めます.

松本眞さんの疑似乱数発生法について
https://mathsoc.jp/publication/tushin/1002/ninomiya.pdf

シミュレーションのための乱数入門
https://www.jspf.or.jp/Journal/PDF_JSPF/9606-08koza.pdf

大規模並列処理と擬似乱数
https://hpc-phys.kek.jp/workshop/workshop190318/saito_190318.pdf

- スライド
- 均等分布次元など要点がわかりやすくまとまっている
- 並列乱数生成の問題点について詳しい

## TODO
- (d)SFMTについて
- 並列化とjump
- 等分布性; n次元等分布うんぬん, 均一分布次元
- 乱数の周期

## 検定
- NIST
- TestU01
- Diehard(er)
検定に合格することは必要条件でも十分条件でもない．
自分の用途に合致すればよいので自分の用途に適したテストを行うべき．
ただし検定は一定のクオリティを示すので，検定に合格する乱数をできるだけ用いた方が良い．

# 文献案内
[Stochastic Simulation and Monte Carlo Methods](https://www-labs.iro.umontreal.ca/~lecuyer/ift6561/book.pdf)

並列乱数生成に詳しいPierre L'Ecuyer氏による500ページ超（2024年5月現在）の講義ノート．
2024年5月現在未完成ながら，最近の擬似乱数生成器，準乱数や並列乱数生成について詳しく書かれている．
メルセンヌツイスターに関しても詳細が書かれている．

[Random Number Generators—Principles and Practices: A Guide for Engineers and Programmers](https://www.amazon.co.jp/dp/1501515136)
乱数生成器についての本．
中身は読んだことないので分からないです．
